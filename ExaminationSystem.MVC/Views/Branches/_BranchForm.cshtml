@model ExaminationSystem.MVC.ViewModels.BranchViewModels.BranchEditViewModel

<div class="modal-header">
	<h5 class="modal-title" id="branchModalLabel">
		@(Model.Id == 0 ? "Add New Branch" : "Edit Branch - " + Model.LocationName)
	</h5>
	<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<div class="modal-body">
	<form id="branchForm" method="post" action="@Url.Action(Model.Id == 0 ? "Add" : "Edit", "Branches")">
		<input type="hidden" name="Id" value="@Model.Id" />

		<div class="mb-3">
			<label for="ZipCode" class="form-label">Location (Zip Code)</label>
			<select id="ZipCode" name="ZipCode" class="select2 form-select form-select-lg" required>
				<option value="" disabled>Select a location</option>
				@foreach (var location in ViewBag.Locations)
				{
					<option value="@location.ZipCode" selected="@(location.ZipCode == Model.ZipCode)">
						@location.LocationName
					</option>
				}
			</select>
		</div>

		<div class="mb-3">
			<label for="StreetNo" class="form-label">Street Number</label>
			<input type="number" class="form-control" id="StreetNo" name="StreetNo" value="@Model.StreetNo" required />
		</div>

	</form>
</div>
<div class="modal-footer">
	<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
	<button type="submit" class="btn btn-primary" id="submitBranchForm">
		@(Model.Id == 0 ? "Add Branch" : "Save Changes")
	</button>
</div>

<script>
	$(document).ready(function () {
		// Initialize Select2 for Location field
		$(document).on('shown.bs.modal', '#branchModal', function () {
			$('#ZipCode').select2({
				placeholder: "Select a location",
				allowClear: true,
				dropdownParent: $('#branchModal')
			}).trigger('change');
		});

		// Handle form submission for Add/Edit Branch
		$('#branchForm').on('submit', function (e) {
			e.preventDefault();

			var formData = $(this).serialize(); // Serialize the form data

			$.ajax({
				type: 'POST',
				url: $(this).attr('action'),
				data: formData,
				success: function (response) {
					if (response.success) {
						$('#branchModal').modal('hide');

						// Handle response to update UI if editing, or reload the page if adding
						if (response.branch) {
							$('#branch-' + response.branch.Id + ' .locName').text(response.branch.LocationName);
							$('#branch-' + response.branch.Id + ' .streetNo').text(response.branch.StreetNo);
							$('#branch-' + response.branch.Id + ' .location').text(response.branch.ZipCode);
						} else {
							// Add the new branch (if adding)
							$('#branch-list').append('<tr id="branch-' + response.id + '"> <!-- add branch HTML here --> </tr>');
						}
					} else {
						alert('Error: ' + response.message);
					}
				},
				error: function () {
					alert('An error occurred while saving the branch.');
				}
			});
		});
	});
</script>
